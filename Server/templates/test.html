<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <link rel="canonical" href="https://inspiredlabs.github.io/ar.js/markerless.html" />
  <script type="text/javascript" src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://aframe.io/releases/0.9.2/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script><!-- debug -->
  
  <script>
    window.onload = () => {
      let scene = document.querySelector('a-scene'); /* Apply to whole scene */

      arjs = document.createAttribute('arjs')
      arjs.value = 'sourceType: webcam; sourceWidth: 1280; sourceHeight: 960; trackingMethod: best; debugUIEnabled: false;'
      scene.setAttributeNode(arjs)
    };
  </script>
</head>

<script>
  var busData = JSON.parse('{{busData | tojson | safe}}');
  // document.getElementById('bus').setAttribute = busData;
  let index = 0;
  previousTriangle = document.getElementById("previousTriangle");
  nextTriangle = document.getElementById('nextTriangle');

  AFRAME.registerComponent('clickhandler', {
    init: function() {
      this.el.addEventListener('click', () => {
        value = Number(this.el.getAttribute('value'))
        if(value > 0){
          console.log('add index')
        }else{console.log('sub index')}
        index += value
        index = fixIndex(index)
        // console.log(index)
        setText(busData[index])
      });
  }});

  function fixIndex(index) {
    if (index < 0){
        index = busData.length - 1;
    } else if (index == busData.length){
        index = 0;
    }
    return index;
  }

  function setText(data) {
    console.log(data);
    console.log('SetText log');
    nearestStopText = document.getElementById("nearestStop");
    nearestStopText.setAttribute('value', 'Stop : ' + data.nearestStopEnglishName);
    console.log('log nearestStop');
    // console.log(data.nearestStop)
    console.log(nearestStopText.getAttribute('value'));


    busNumberText = document.getElementById("busNumber");
    busNumberText.setAttribute('value', 'BusNumber : ' + data.busNumber);

    pathNameStartText = document.getElementById("pathNameStart");
    pathNameEndText = document.getElementById("pathNameEnd");
    var pathStop = data.pathEnglishName.split("|");
    pathNameStartText.setAttribute('value', pathStop[0]);
    pathNameEndText.setAttribute('value', pathStop[1]);
    
    time = document.getElementById("time");
    if( data.estTime != null){
      time.setAttribute('value', 'Arrive in ' + data.estTime + ' min');
    } else if(data.arrivedTime != null){
      time.setAttribute('value', 'Arrived at ' + data.arrivedTime);
    } else {
      time.setAttribute('value', 'This bus seen\'s be cancel');
    }
  }
</script>

<body>
  <a-scene 
    cursor = 'rayOrigin: mouse; fuse: true; fuseTimeout: 0;'
    raycaster = "objects: [clickhandler];"
    vr-mode-ui="enabled: false">
    <a-entity id="wrapper" position="0 0 0">
      <a-plane position="0 2 -15" rotation="0 0 0" width="11" height="12" color="#7BC8A4" shadow></a-plane>
      
      <a-triangle
        id = 'nextTriangle'
        value = '1'
        clickhandler
        height = "5"
        width = "5"
        position="4.5 2 -10"
        rotation="0 0 -90"
        color="blue"
        shadow>
      </a-triangle>
      
      <a-triangle
        id = 'previousTriangle'
        value = '-1'
        clickhandler
        height = "5"
        width = "5"
        position="-4.5 2 -10"
        rotation="0 0 90"
        color="blue"  
        shadow>
      </a-triangle>
      
      <a-text
      id = "nearestStop"
      value="1"
      look-at="[gps-camera]"
      scale="2 2 2"
      position="-3 5 -10"
      color="blue"></a-text>

      <a-text
      id = "busNumber"
      value="2"
      look-at="[gps-camera]"
      scale="2 2 2"
      position="-3 4 -10"
      color="blue"></a-text>

      <a-text
      id = "pathNameStart"
      value="3"
      look-at="[gps-camera]"
      scale="2 2 2"
      position="-3 3 -10"
      color="blue"></a-text>

      <a-text
      id = "to"
      value="   To    "
      look-at="[gps-camera]"
      scale="2 2 2"
      position="-1 2 -10"
      color="blue"></a-text>

      <a-text
      id = "pathNameEnd"
      value="4"
      look-at="[gps-camera]"
      scale="2 2 2"
      position="-3 1 -10"
      color="blue"></a-text>
      

      <a-text
      id = "time"
      value="5"
      look-at="[gps-camera]"
      scale="2 2 2"
      position="-3 0 -10"
      color="blue"></a-text>

    </a-entity>
  
    <a-camera camera = "fov: 60;" rotation-reader></a-camera>
  </a-scene>
</body>
</html>